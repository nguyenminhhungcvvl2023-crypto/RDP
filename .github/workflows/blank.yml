name: ğŸš€ ZUNRDP PREMIUM

on:
  workflow_dispatch:
    inputs:
      token_choice:
        description: 'ğŸ”‘ Chá»n MÃ£ káº¿t ná»‘i (Token 1 hoáº·c 2)'
        required: true
        default: 'Token_1'
        type: choice
        options:
        - 'Token_1'
        - 'Token_2'
      tailscale_name:
        description: 'ğŸ·ï¸ Äáº·t tÃªn cho mÃ¡y nÃ y (Hiá»‡n trÃªn Tailscale)'
        required: true
        default: 'zun-vps-cua-toi'
      duration:
        description: 'ğŸ• Báº¡n muá»‘n treo mÃ¡y trong bao lÃ¢u?'
        required: true
        default: 'Den_Khi_Tu_Tat'
        type: choice
        options:
        - 'Treo_1_Tieng'
        - 'Treo_3_Tieng' 
        - 'Den_Khi_Tu_Tat'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 360 # GitHub sáº½ tá»± táº¯t sau 6 tiáº¿ng (360 phÃºt)
    
    steps:
      - name: ğŸ¯ Báº®T Äáº¦U KHá»I Táº O
        run: |
          Write-Host "ğŸ¤– Há»† THá»NG ZUNRDP ÄANG CHUáº¨N Bá»Š..." -ForegroundColor Yellow
          Write-Host "âš™ï¸ Cháº¿ Ä‘á»™: ${{ github.event.inputs.duration }}" -ForegroundColor Cyan

      - name: ğŸ”§ Cáº¤U HÃŒNH MÃY áº¢O
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Zun" dir=in action=allow protocol=TCP localport=3389 profile=any
          Start-Service -Name TermService -ErrorAction SilentlyContinue

      - name: ğŸ‘¤ Táº O TÃŠN ÄÄ‚NG NHáº¬P
        run: |
          $Username = "ADMINZUN"
          $PassText = "ZunRDP@123456"
          $Password = ConvertTo-SecureString $PassText -AsPlainText -Force
          if (Get-LocalUser -Name $Username -ErrorAction SilentlyContinue) { Remove-LocalUser -Name $Username }
          New-LocalUser -Name $Username -Password $Password -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username

      - name: ğŸŒ Káº¾T Ná»I Máº NG TAILSCALE
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }}
          TOKEN_2: ${{ secrets.TAILSCALE_AUTH_KEY_2 }}
        run: |
          $SelectedToken = if ("${{ github.event.inputs.token_choice }}" -eq "Token_1") { $env:TOKEN_1 } else { $env:TOKEN_2 }
          $CustomName = "${{ github.event.inputs.tailscale_name }}"
          
          if (-not $SelectedToken) { 
              Write-Host "âŒ Lá»–I: Báº¡n chÆ°a cÃ i mÃ£ Secret trong pháº§n CÃ i Ä‘áº·t!" -ForegroundColor Red
              exit 1 
          }

          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 5
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$SelectedToken --hostname=$CustomName --accept-routes --reset
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: ğŸ‰ THÃ”NG TIN Äá»‚ Báº N ÄÄ‚NG NHáº¬P
        run: |
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚ Äá»‹a chá»‰ IP : $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ TÃ i khoáº£n  : ADMINZUN" -ForegroundColor White
          Write-Host "â”‚ Máº­t kháº©u   : ZunRDP@123456" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

      - name: â³ TRáº NG THÃI TREO MÃY
        run: |
          $choice = "${{ github.event.inputs.duration }}"
          
          if ($choice -eq "Den_Khi_Tu_Tat") {
              Write-Host "ğŸ”„ Äang treo mÃ¡y á»Ÿ má»©c tá»‘i Ä‘a (GitHub sáº½ tá»± táº¯t sau khoáº£ng 6 tiáº¿ng)" -ForegroundColor Magenta
              while($true) {
                  Write-Host "â³ MÃ¡y váº«n Ä‘ang cháº¡y... $(Get-Date -Format 'HH:mm:ss')"
                  Start-Sleep -Seconds 60
              }
          } else {
              $m = if ($choice -eq "Treo_1_Tieng") { 60 } else { 180 }
              $endTime = (Get-Date).AddMinutes($m)
              while ((Get-Date) -lt $endTime) {
                  $timeLeft = $endTime - (Get-Date)
                  Write-Host "`râ³ Thá»i gian cÃ²n láº¡i: $($timeLeft.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Green
                  Start-Sleep -Seconds 30
              }
          }

      - name: ğŸ§¹ THOÃT Há»† THá»NG
        if: always()
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout
          
