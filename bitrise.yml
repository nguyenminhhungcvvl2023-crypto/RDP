---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: other

meta:
  bitrise.io:
    stack: linux-docker-android-22.04
    machine_type_id: elite

workflows:
  primary:
    steps:
    - script@1:
        title: "ğŸš€ Initialize Windows RDP System"
        inputs:
        - content: |
            #!/bin/bash
            set -e
            
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                                       â•‘"
            echo "â•‘        ğŸ–¥ï¸  WINDOWS 11 REMOTE DESKTOP - INITIALIZING                  â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # [1/4] Create Docker Compose
            echo "[1/4] ğŸ³ Creating Docker configuration..."
            cat <<EOF > docker-compose.yml
            version: "3.9"
            services:
              windows:
                image: dockurr/windows
                container_name: windows_rdp
                privileged: true
                environment:
                  VERSION: "11"
                  USERNAME: "Zun"
                  PASSWORD: "123456"
                  RAM_SIZE: "28G"
                  CPU_CORES: "8"
                  DISK_SIZE: "100G"
                  KVM: "Y"
                devices:
                  - /dev/kvm:/dev/kvm
                cap_add:
                  - NET_ADMIN
                  - SYS_ADMIN
                security_opt:
                  - apparmor:unconfined
                  - seccomp:unconfined
                ports:
                  - "8006:8006"
                  - "3389:3389/tcp"
                  - "3389:3389/udp"
                  - "5900:5900"
                volumes:
                  - ./storage:/storage
                restart: always
                stop_grace_period: 2m
            EOF
            echo "      âœ… Docker Compose created"
            
            # [2/4] Start Docker Container
            echo "[2/4] ğŸš€ Starting Windows 11 container..."
            docker compose up -d > /dev/null 2>&1
            echo "      âœ… Container started successfully"
            
            # [3/4] Download Kami Tunnel
            echo "[3/4] ğŸ“¥ Downloading Kami Tunnel..."
            wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
            tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
            chmod +x kami-tunnel
            echo "      âœ… Kami Tunnel ready"
            
            # [4/4] Start Tunnels
            echo "[4/4] ğŸŒ Starting tunnel services..."
            
            # Tunnel cho RDP (3389)
            nohup ./kami-tunnel 3389 > tunnel_rdp.log 2>&1 &
            RDP_PID=$!
            echo "      âœ… RDP Tunnel started (PID: $RDP_PID)"
            
            sleep 3
            
            # Tunnel cho Web Viewer (8006)
            nohup ./kami-tunnel 8006 > tunnel_web.log 2>&1 &
            WEB_PID=$!
            echo "      âœ… Web Viewer Tunnel started (PID: $WEB_PID)"
            
            sleep 3
            
            # Tunnel cho VNC (5900)
            nohup ./kami-tunnel 5900 > tunnel_vnc.log 2>&1 &
            VNC_PID=$!
            echo "      âœ… VNC Tunnel started (PID: $VNC_PID)"
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… All services started successfully!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

    - script@1:
        title: "ğŸŒ Get Connection Information"
        inputs:
        - content: |
            #!/bin/bash
            
            echo ""
            echo "ğŸ”„ Establishing tunnel connections..."
            echo ""
            
            # ===== Láº¥y IP cho RDP (Port 3389) =====
            echo "â³ Waiting for RDP tunnel (Port 3389)..."
            RDP_IP=""
            RETRY=0
            
            while [ -z "$RDP_IP" ] && [ $RETRY -lt 60 ]; do
              if [ -f kami_tunnel.txt ]; then
                RDP_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
                if [[ "$RDP_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
                  RDP_IP="$RDP_CONTENT"
                  echo "âœ… RDP tunnel ready: $RDP_IP"
                  break
                fi
              fi
              sleep 2
              RETRY=$((RETRY + 1))
              if [ $((RETRY % 10)) -eq 0 ]; then
                echo "   Still waiting... ($RETRY/60)"
              fi
            done
            
            if [ -z "$RDP_IP" ]; then
              echo "âŒ ERROR: RDP tunnel failed"
              cat tunnel_rdp.log 2>/dev/null || true
              exit 1
            fi
            
            # Backup file
            cp kami_tunnel.txt rdp_backup.txt
            
            # ===== Láº¥y IP cho Web Viewer (Port 8006) =====
            echo ""
            echo "â³ Waiting for Web Viewer tunnel (Port 8006)..."
            WEB_IP=""
            RETRY=0
            sleep 3
            
            while [ -z "$WEB_IP" ] && [ $RETRY -lt 60 ]; do
              if [ -f kami_tunnel.txt ]; then
                WEB_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
                if [[ "$WEB_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]] && [ "$WEB_CONTENT" != "$RDP_IP" ]; then
                  WEB_IP="$WEB_CONTENT"
                  echo "âœ… Web Viewer tunnel ready: $WEB_IP"
                  break
                fi
              fi
              sleep 2
              RETRY=$((RETRY + 1))
              if [ $((RETRY % 10)) -eq 0 ]; then
                echo "   Still waiting... ($RETRY/60)"
              fi
            done
            
            if [ -z "$WEB_IP" ]; then
              WEB_IP="N/A"
              echo "âš ï¸  Web Viewer tunnel not available"
            fi
            
            # Backup file
            cp kami_tunnel.txt web_backup.txt
            
            # ===== Láº¥y IP cho VNC (Port 5900) =====
            echo ""
            echo "â³ Waiting for VNC tunnel (Port 5900)..."
            VNC_IP=""
            RETRY=0
            sleep 3
            
            while [ -z "$VNC_IP" ] && [ $RETRY -lt 60 ]; do
              if [ -f kami_tunnel.txt ]; then
                VNC_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
                if [[ "$VNC_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]] && [ "$VNC_CONTENT" != "$RDP_IP" ] && [ "$VNC_CONTENT" != "$WEB_IP" ]; then
                  VNC_IP="$VNC_CONTENT"
                  echo "âœ… VNC tunnel ready: $VNC_IP"
                  break
                fi
              fi
              sleep 2
              RETRY=$((RETRY + 1))
              if [ $((RETRY % 10)) -eq 0 ]; then
                echo "   Still waiting... ($RETRY/60)"
              fi
            done
            
            if [ -z "$VNC_IP" ]; then
              VNC_IP="N/A"
              echo "âš ï¸  VNC tunnel not available"
            fi
            
            # ===== Hiá»ƒn thá»‹ thÃ´ng tin káº¿t ná»‘i =====
            echo ""
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                                       â•‘"
            echo "â•‘              âœ… WINDOWS 11 PROFESSIONAL - READY                       â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸ”Œ REMOTE DESKTOP (RDP)                                              â•‘"
            echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
            echo "â•‘  ğŸŒ  RDP Address    : $RDP_IP"
            echo "â•‘  ğŸ‘¤  Username       : Zun                                             â•‘"
            echo "â•‘  ğŸ”  Password       : 123456                                          â•‘"
            echo "â•‘  ğŸ“  Port           : 3389                                            â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸŒ WEB VIEWER                                                        â•‘"
            echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
            echo "â•‘  ğŸ”—  Web Address    : http://$WEB_IP"
            echo "â•‘  ğŸ“  Port           : 8006                                            â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸ–¥ï¸  VNC VIEWER                                                       â•‘"
            echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
            echo "â•‘  ğŸŒ  VNC Address    : $VNC_IP"
            echo "â•‘  ğŸ“  Port           : 5900                                            â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•‘  ğŸ’» SYSTEM RESOURCES                                                  â•‘"
            echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
            echo "â•‘  âš¡  CPU            : 8 vCPU                                          â•‘"
            echo "â•‘  ğŸ§   RAM            : 28GB                                            â•‘"
            echo "â•‘  ğŸ’¾  Storage        : 100GB                                           â•‘"
            echo "â•‘                                                                       â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ’¡ TIP: Use Web Viewer to monitor Windows installation progress!"
            echo "ğŸ’¡ RDP: Best for remote desktop access"
            echo "ğŸ’¡ VNC: Alternative graphical access method"
            echo ""
            
            # LÆ°u vÃ o file cho step sau
            envman add --key RDP_IP --value "$RDP_IP"
            envman add --key WEB_IP --value "$WEB_IP"
            envman add --key VNC_IP --value "$VNC_IP"

    - script@1:
        title: "â° Maintain Active Session"
        inputs:
        - content: |
            #!/bin/bash
            
            echo ""
            echo "ğŸŸ¢ Windows 11 session started - Running continuously..."
            echo ""
            
            # Hiá»ƒn thá»‹ Docker logs ban Ä‘áº§u
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  ğŸ“‹ DOCKER CONTAINER STATUS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Maintain session vá»›i status report má»—i 5 phÃºt
            COUNTER=0
            while true; do
              ELAPSED=$((COUNTER * 5))
              
              # Status report má»—i 30 phÃºt (6 láº§n)
              if [ $((COUNTER % 6)) -eq 0 ]; then
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "  ğŸ–¥ï¸  WINDOWS 11 - STATUS REPORT"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "  ğŸ“… Timestamp      : $(date +'%Y-%m-%d %H:%M:%S')"
                echo "  â±ï¸  Uptime         : ${ELAPSED} minutes"
                echo "  ğŸŒ RDP Connection : $RDP_IP"
                echo "  ğŸŒ Web Viewer     : http://$WEB_IP"
                echo "  ğŸ–¥ï¸  VNC Viewer     : $VNC_IP"
                echo "  ğŸŸ¢ Status         : ACTIVE & RUNNING"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                
                # Hiá»ƒn thá»‹ má»™t vÃ i dÃ²ng log gáº§n nháº¥t
                echo "ğŸ“‹ Recent Docker Logs:"
                docker compose logs --tail=5 2>/dev/null || true
                echo ""
              fi
              
              # Progress indicator
              echo -ne "  ğŸŸ¢ Windows 11 Active | â±ï¸  Uptime: ${ELAPSED} minutes\r"
              
              sleep 300  # 5 phÃºt
              COUNTER=$((COUNTER + 1))
            done

triggers:
  push:
    branch: main
  pull_request:
    source_branch: "*"
